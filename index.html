<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>V-PRO - Dashboard Cloud</title>
    <link rel="stylesheet" href="style.css">
    <style>
        :root { --primary: #4f46e5; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --slate-800: #1e293b; }
        body { background: #f1f5f9; font-family: 'Inter', sans-serif; margin: 0; }
        .nav { background: var(--slate-800); padding: 1rem 2rem; display: flex; justify-content: space-between; color: white; align-items: center; }
        .nav a { color: #94a3b8; text-decoration: none; margin-left: 1rem; font-weight: 600; }
        
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 20px; }
        
        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-top: 4px solid var(--primary); }
        .stat-card h3 { margin: 0; color: #64748b; font-size: 14px; text-transform: uppercase; }
        .stat-card .value { font-size: 24px; font-weight: 800; margin: 10px 0; color: var(--slate-800); }
        
        /* Layout Grid */
        .layout-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        .alert-item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #f1f5f9; align-items: center; }
        .badge-low { background: #fee2e2; color: #b91c1c; padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 12px; }
        
        h2 { font-size: 18px; margin-top: 0; color: var(--slate-800); }
    </style>
</head>
<body>

<nav class="nav">
    <strong>UNIVERSAL GROUP V-PRO</strong>
    <div>
        <a href="index.html" style="color:white">Dashboard</a>
        <a href="produk.html">Produk</a>
        <a href="pembelian.html">Pembelian</a>
        <a href="penjualan.html">Penjualan</a>
    </div>
</nav>

<div class="container">
    <div class="stats-grid">
        <div class="stat-card">
            <h3>Total Omzet (Sales)</h3>
            <div class="value" id="dashSales">Rp 0</div>
        </div>
        <div class="stat-card" style="border-top-color: var(--success);">
            <h3>Estimasi Profit</h3>
            <div class="value" id="dashProfit" style="color: var(--success);">Rp 0</div>
        </div>
        <div class="stat-card" style="border-top-color: var(--warning);">
            <h3>Total Pesanan</h3>
            <div class="value" id="dashOrders">0</div>
        </div>
    </div>

    <div class="layout-grid">
        <div class="card">
            <h2>Riwayat Penjualan Terakhir</h2>
            <table style="width:100%; border-collapse: collapse; font-size: 13px;">
                <thead>
                    <tr style="text-align: left; color: #64748b; border-bottom: 2px solid #f1f5f9;">
                        <th style="padding: 12px 8px;">Bulan/Periode</th>
                        <th>Marketplace</th>
                        <th>Toko</th>
                        <th style="text-align: right;">Profit</th>
                    </tr>
                </thead>
                <tbody id="salesTableBody">
                    </tbody>
            </table>
        </div>

        <div class="card">
            <h2>⚠️ Stok Menipis</h2>
            <div id="lowStockList">
                <p style="color: #94a3b8; font-size: 13px;">Memuat data stok...</p>
            </div>
        </div>
    </div>
</div>



<script type="module">
    import { CloudDB } from './core-db.js';

    // Fungsi format rupiah
    const formatIDR = (num) => "Rp " + new Number(num).toLocaleString('id-ID');

    async function loadDashboard() {
        try {
            // 1. Ambil Data Penjualan
            const salesData = await CloudDB.getAll("sales_history");
            
            let totalSales = 0;
            let totalProfit = 0;
            let totalOrders = 0;

            const tableBody = document.getElementById('salesTableBody');
            tableBody.innerHTML = '';

            // Urutkan data berdasarkan input terbaru
            salesData.forEach(s => {
                totalSales += s.sales || 0;
                totalProfit += s.profit || 0;
                totalOrders += s.orders || 0;

                tableBody.innerHTML += `
                    <tr style="border-bottom: 1px solid #f8fafc;">
                        <td style="padding: 12px 8px;">${s.month}</td>
                        <td>${s.mplace}</td>
                        <td>${s.store}</td>
                        <td style="text-align: right; font-weight: bold; color: var(--success);">${formatIDR(s.profit)}</td>
                    </tr>
                `;
            });

            document.getElementById('dashSales').innerText = formatIDR(totalSales);
            document.getElementById('dashProfit').innerText = formatIDR(totalProfit);
            document.getElementById('dashOrders').innerText = totalOrders.toLocaleString('id-ID');

            // 2. Cek Stok Menipis
            const products = await CloudDB.getAll("products");
            const history = await CloudDB.getAll("stock_history");
            const lowStockDiv = document.getElementById('lowStockList');
            lowStockDiv.innerHTML = '';

            let countLow = 0;
            products.forEach(p => {
                const stok = history
                    .filter(h => h.sku === p.id)
                    .reduce((total, h) => total + (h.type === 'IN' ? h.qty : -h.qty), 0);
                
                if (stok <= 5) {
                    countLow++;
                    lowStockDiv.innerHTML += `
                        <div class="alert-item">
                            <div>
                                <div style="font-weight:bold">${p.id}</div>
                                <div style="font-size:11px; color:#64748b">${p.nama}</div>
                            </div>
                            <span class="badge-low">${stok} Unit</span>
                        </div>
                    `;
                }
            });

            if(countLow === 0) {
                lowStockDiv.innerHTML = '<p style="color:var(--success); font-size:13px;">✅ Semua stok aman.</p>';
            }

        } catch (error) {
            console.error("Dashboard Error:", error);
        }
    }

    // Jalankan saat halaman dibuka
    loadDashboard();
</script>

</body>
</html>
