<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Universal Group - Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <style>
        :root {
            --primary: #6366f1; --success: #10b981; --danger: #ef4444; 
            --slate-50: #f8fafc; --slate-100: #f1f5f9; --slate-700: #334155; --slate-800: #1e293b;
        }
        body { background-color: #f4f7ff; color: var(--slate-800); font-family: 'Inter', sans-serif; margin: 0; font-size: 14px; }
        .nav { background: var(--slate-800); padding: 0.75rem 2rem; display: flex; justify-content: space-between; align-items: center; color: white; }
        .nav-brand { font-weight: 800; letter-spacing: 1px; font-size: 1.1rem; }
        .nav-links a { color: #94a3b8; text-decoration: none; margin-left: 1.5rem; font-size: 0.85rem; font-weight: 600; }
        .nav-links a.active { color: white; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        .header-box { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); overflow: hidden; border: 1px solid var(--slate-100); }
        table { width: 100%; border-collapse: collapse; }
        th { background: var(--slate-50); padding: 1rem; text-align: left; border-bottom: 2px solid var(--slate-100); font-size: 0.75rem; color: var(--slate-700); text-transform: uppercase; }
        td { padding: 0.8rem 1rem; border-bottom: 1px solid var(--slate-100); }
        .btn { padding: 0.4rem 0.8rem; border-radius: 6px; border: none; font-weight: 700; cursor: pointer; font-size: 0.75rem; transition: 0.2s; }
        .btn-danger { background: #fee2e2; color: var(--danger); }
        .btn-danger:hover { background: var(--danger); color: white; }
        .btn-clear { background: var(--danger); color: white; padding: 0.6rem 1.2rem; }
        .group-header { background: #eef2ff; font-weight: 800; color: var(--primary); }
        .subtotal-row { background: #fafafa; font-weight: 700; color: var(--slate-700); }
        .grand-total-row { background: var(--slate-800); color: white; font-weight: 800; }
        .text-right { text-align: right; }
    </style>
</head>
<body>

<nav class="nav">
    <div class="nav-brand">UNIVERSAL GROUP <strong>V-PRO MAX</strong></div>
    <div class="nav-links">
        <a href="index.html" style="color:white">Dashboard</a>
        <a href="produk.html">Produk & Stok</a>
        <a href="pembelian.html">Pembelian</a>
        <a href="penjualan.html">Penjualan</a>
    </div>
</nav>

<div class="container">
    <div class="header-box">
        <h2 style="margin:0">Rekapitulasi Penjualan</h2>
        <button class="btn btn-clear" onclick="hapusSemuaHistory()">ðŸ—‘ Hapus Semua History</button>
    </div>

    <div class="card">
        <table>
            <thead>
                <tr>
                    <th>Bulan</th>
                    <th>Nama Toko</th>
                    <th>Platform</th>
                    <th class="text-right">Pesanan</th>
                    <th class="text-right">Omzet</th>
                    <th class="text-right">Profit</th>
                    <th style="width: 50px; text-align: center;">Aksi</th>
                </tr>
            </thead>
            <tbody id="listHistory"></tbody>
        </table>
    </div>
</div>

<script src="core-db.js"></script>
<script>
    let db;
    CoreDB.init().then(res => { db = res; muatData(); });

    function formatIDR(n) { return "Rp " + Math.round(n).toLocaleString('id-ID'); }

    function muatData() {
        const tx = db.transaction("history", "readonly");
        const store = tx.objectStore("history");
        
        // Menggunakan getAll() dan getAllKeys() secara paralel untuk mendapatkan ID asli dari IndexedDB
        Promise.all([
            new Promise(r => store.getAll().onsuccess = e => r(e.target.result)),
            new Promise(r => store.getAllKeys().onsuccess = e => r(e.target.result))
        ]).then(([data, keys]) => {
            const body = document.getElementById('listHistory');
            
            if(!data || data.length === 0) {
                body.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:3rem; color:#94a3b8;">Belum ada data rekap tersimpan.</td></tr>';
                return;
            }

            // Gabungkan data dengan key-nya
            const dataWithKeys = data.map((item, index) => ({ ...item, dbKey: keys[index] }));

            // Grouping per Platform
            const grouped = dataWithKeys.reduce((acc, curr) => {
                if (!acc[curr.mplace]) acc[curr.mplace] = [];
                acc[curr.mplace].push(curr);
                return acc;
            }, {});

            body.innerHTML = '';
            let gOrd = 0, gSal = 0, gPrf = 0;

            for (const platform in grouped) {
                let sOrd = 0, sSal = 0, sPrf = 0;
                body.innerHTML += `<tr class="group-header"><td colspan="7">${platform}</td></tr>`;
                
                grouped[platform].forEach((item) => {
                    sOrd += item.orders; sSal += item.sales; sPrf += item.profit;
                    body.innerHTML += `<tr>
                        <td>${item.month}</td>
                        <td>${item.store}</td>
                        <td>${item.mplace}</td>
                        <td class="text-right">${item.orders}</td>
                        <td class="text-right">${formatIDR(item.sales)}</td>
                        <td class="text-right" style="color:var(--success); font-weight:700;">${formatIDR(item.profit)}</td>
                        <td style="text-align:center;">
                            <button class="btn btn-danger" onclick="hapusSatuHistory(${item.dbKey})">âœ•</button>
                        </td>
                    </tr>`;
                });

                body.innerHTML += `<tr class="subtotal-row">
                    <td colspan="3" class="text-right">SUB TOTAL ${platform.toUpperCase()}</td>
                    <td class="text-right">${sOrd}</td>
                    <td class="text-right">${formatIDR(sSal)}</td>
                    <td class="text-right">${formatIDR(sPrf)}</td>
                    <td></td>
                </tr>`;
                
                gOrd += sOrd; gSal += sSal; gPrf += sPrf;
            }

            body.innerHTML += `<tr class="grand-total-row">
                <td colspan="3" class="text-right">GRAND TOTAL KESELURUHAN</td>
                <td class="text-right">${gOrd}</td>
                <td class="text-right">${formatIDR(gSal)}</td>
                <td class="text-right">${formatIDR(gPrf)}</td>
                <td></td>
            </tr>`;
        });
    }

    function hapusSatuHistory(id) {
        if(!confirm("Hapus data baris ini?")) return;
        const tx = db.transaction("history", "readwrite");
        tx.objectStore("history").delete(id);
        tx.oncomplete = () => muatData();
    }

    function hapusSemuaHistory() {
        if(!confirm("PERINGATAN! Semua history penjualan akan dihapus permanen. Lanjutkan?")) return;
        const tx = db.transaction("history", "readwrite");
        tx.objectStore("history").clear();
        tx.oncomplete = () => muatData();
    }
</script>
</body>
</html>