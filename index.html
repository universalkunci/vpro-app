<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - V-PRO MAX</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        :root {
            --primary: #4f46e5; --success: #10b981; --danger: #ef4444; 
            --slate-50: #f8fafc; --slate-100: #f1f5f9; --slate-700: #334155; --slate-800: #1e293b;
        }
        body { background-color: #f4f7ff; color: var(--slate-800); font-family: 'Inter', sans-serif; margin: 0; font-size: 14px; }
        .nav { background: var(--slate-800); padding: 0.75rem 2rem; display: flex; justify-content: space-between; align-items: center; color: white; }
        .nav-brand { font-weight: 700; display: flex; align-items: center; gap: 8px; font-size: 1.1rem; }
        .nav-links a { color: #94a3b8; text-decoration: none; margin-left: 1.5rem; font-size: 0.85rem; font-weight: 600; transition: 0.2s; }
        .nav-links a.active { color: white; border-bottom: 2px solid var(--primary); padding-bottom: 4px; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); overflow: hidden; border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; }
        th { background: var(--slate-50); padding: 1rem; text-align: left; border-bottom: 2px solid var(--slate-100); font-size: 0.7rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; }
        td { padding: 1rem; border-bottom: 1px solid var(--slate-100); }
        .btn { display: inline-flex; align-items: center; gap: 6px; padding: 0.6rem 1rem; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; font-size: 0.8rem; transition: 0.2s; }
        .btn-danger { background: #fee2e2; color: var(--danger); }
        .btn-danger:hover { background: var(--danger); color: white; }
        .text-right { text-align: right; }
        .group-header { background: #f1f5f9; color: var(--primary); font-weight: 700; }
        .grand-total-row { background: var(--slate-800); color: white; font-weight: 700; }
    </style>
</head>
<body>

<nav class="nav">
    <div class="nav-brand"><i data-lucide="layout-dashboard"></i> V-PRO MAX</div>
    <div class="nav-links">
        <a href="index.html" class="active">Dashboard</a>
        <a href="produk.html">Produk</a>
        <a href="pembelian.html">Pembelian</a>
        <a href="penjualan.html">Penjualan</a>
    </div>
</nav>

<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2 style="font-weight: 700; color: var(--slate-800);">Rekap Penjualan</h2>
        <button class="btn btn-danger" onclick="hapusSemuaHistory()"><i data-lucide="trash-2" size="16"></i> Hapus Semua</button>
    </div>

    <div class="card">
        <table>
            <thead>
                <tr>
                    <th>Bulan</th>
                    <th>Toko</th>
                    <th>Platform</th>
                    <th class="text-right">Orders</th>
                    <th class="text-right">Omzet</th>
                    <th class="text-right">Profit</th>
                    <th style="width: 50px;"></th>
                </tr>
            </thead>
            <tbody id="listHistory"></tbody>
        </table>
    </div>
</div>

<script src="core-db.js"></script>
<script>
    let db;
    CoreDB.init().then(res => { db = res; muatData(); });

    function formatIDR(n) { return "Rp " + Math.round(n).toLocaleString('id-ID'); }

    function muatData() {
        const tx = db.transaction("history", "readonly");
        const store = tx.objectStore("history");
        
        Promise.all([
            new Promise(r => store.getAll().onsuccess = e => r(e.target.result)),
            new Promise(r => store.getAllKeys().onsuccess = e => r(e.target.result))
        ]).then(([data, keys]) => {
            const body = document.getElementById('listHistory');
            body.innerHTML = '';
            
            if(!data || data.length === 0) {
                body.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:3rem; color:#94a3b8;">Belum ada data history.</td></tr>';
                return;
            }

            const dataWithKeys = data.map((item, index) => ({ ...item, dbKey: keys[index] }));
            const grouped = dataWithKeys.reduce((acc, curr) => {
                if (!acc[curr.mplace]) acc[curr.mplace] = [];
                acc[curr.mplace].push(curr);
                return acc;
            }, {});

            let gOrd = 0, gSal = 0, gPrf = 0;
            for (const platform in grouped) {
                body.innerHTML += `<tr class="group-header"><td colspan="7"><i data-lucide="tag" size="12"></i> PLATFORM: ${platform}</td></tr>`;
                grouped[platform].forEach(item => {
                    gOrd += item.orders; gSal += item.sales; gPrf += item.profit;
                    body.innerHTML += `<tr>
                        <td>${item.month}</td>
                        <td style="font-weight:600">${item.store}</td>
                        <td><span style="background:#e0e7ff; color:#4338ca; padding:2px 8px; border-radius:4px; font-size:11px;">${item.mplace}</span></td>
                        <td class="text-right">${item.orders}</td>
                        <td class="text-right">${formatIDR(item.sales)}</td>
                        <td class="text-right" style="color:var(--success); font-weight:700;">${formatIDR(item.profit)}</td>
                        <td><button class="btn btn-danger" style="padding:4px;" onclick="hapusSatuHistory(${item.dbKey})"><i data-lucide="x" size="14"></i></button></td>
                    </tr>`;
                });
            }
            body.innerHTML += `<tr class="grand-total-row"><td colspan="3">TOTAL KESELURUHAN</td><td class="text-right">${gOrd}</td><td class="text-right">${formatIDR(gSal)}</td><td class="text-right">${formatIDR(gPrf)}</td><td></td></tr>`;
            lucide.createIcons();
        });
    }

    function hapusSatuHistory(id) { if(confirm("Hapus baris ini?")) { db.transaction("history", "readwrite").objectStore("history").delete(id); muatData(); } }
    function hapusSemuaHistory() { if(confirm("Hapus semua history?")) { db.transaction("history", "readwrite").objectStore("history").clear(); muatData(); } }
</script>
</body>
</html>