<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Universal Group - Penjualan V7</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #4f46e5; --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
            --slate-50: #f8fafc; --slate-200: #e2e8f0; --slate-700: #334155; --slate-800: #1e293b;
        }
        body { background-color: #f1f5f9; color: var(--slate-800); font-family: 'Inter', sans-serif; margin: 0; font-size: 13px; }
        .nav { background: var(--slate-800); padding: 0.75rem 2rem; display: flex; justify-content: space-between; align-items: center; color: white; }
        .nav-brand { font-weight: 800; letter-spacing: 1px; }
        .nav-links a { color: #94a3b8; text-decoration: none; margin-left: 1.5rem; font-weight: 600; font-size: 0.85rem; }
        .nav-links a.active { color: white; }
        .container { max-width: 1300px; margin: 1.5rem auto; padding: 0 1rem; }
        .card { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 1.5rem; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; align-items: flex-end; }
        .field { display: flex; flex-direction: column; gap: 0.4rem; }
        .field label { font-size: 11px; font-weight: 700; color: var(--slate-700); text-transform: uppercase; }
        input, select { padding: 0.6rem; border: 1px solid var(--slate-200); border-radius: 8px; outline: none; font-size: 13px; }
        .stats-bar { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-item { background: white; padding: 1rem; border-radius: 10px; border-left: 4px solid var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .stat-item span { display: block; font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase; }
        .stat-item strong { font-size: 1.1rem; color: var(--slate-800); }
        .table-wrapper { background: white; border-radius: 10px; overflow: hidden; border: 1px solid var(--slate-200); }
        table { width: 100%; border-collapse: collapse; }
        th { background: var(--slate-50); padding: 10px; text-align: left; font-size: 11px; color: var(--slate-700); border-bottom: 1px solid var(--slate-200); text-transform: uppercase; }
        td { padding: 10px; border-bottom: 1px solid var(--slate-50); font-size: 13px; }
        .btn { padding: 0.7rem 1.2rem; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; font-size: 13px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; width: 100%; margin-top: 1rem; }
        .text-profit { color: var(--success); font-weight: 700; }
        .text-loss { color: var(--danger); font-weight: 700; }
    </style>
</head>
<body>

<nav class="nav">
    <div class="nav-brand">UNIVERSAL GROUP <small style="opacity: 0.5; font-size: 10px;">V7</small></div>
    <div class="nav-links">
        <a href="index.html">Home</a>
        <a href="produk.html">Produk</a>
        <a href="penjualan.html" class="active">Penjualan</a>
    </div>
</nav>

<div class="container">
    <div class="card">
        <div class="form-grid">
            <div class="field"><label>Platform</label>
                <select id="mPlace">
                    <option value="Shopee">Shopee</option>
                    <option value="Tokopedia">Tokopedia</option>
                    <option value="Lazada">Lazada</option>
                </select>
            </div>
            <div class="field"><label>Nama Toko</label><input type="text" id="storeName" placeholder="Toko A"></div>
            <div class="field"><label>Bulan</label><select id="reportMonth">
                <option>Januari</option><option>Februari</option><option>Maret</option><option>April</option><option>Mei</option><option>Juni</option>
                <option>Juli</option><option>Agustus</option><option>September</option><option>Oktober</option><option>November</option><option>Desember</option>
            </select></div>
            <div class="field"><label>Admin %</label><input type="number" id="admRate" value="18"></div>
            <div class="field"><label>Biaya Proses</label><input type="number" id="procFee" value="1250"></div>
            <div class="field" style="grid-column: span 2;"><label>File Laporan</label><input type="file" id="fileIn"></div>
            <button class="btn btn-primary" onclick="prosesKalkulasi()">Mulai Kalkulasi V7</button>
        </div>
    </div>

    <div id="resArea" style="display: none;">
        <div class="stats-bar">
            <div class="stat-item"><span>Total Pesanan</span><strong id="outOrd">0</strong></div>
            <div class="stat-item"><span>Total Omzet</span><strong id="outSal">0</strong></div>
            <div class="stat-item" style="border-left-color: var(--danger)"><span>Total Admin + HPP</span><strong id="outCost">0</strong></div>
            <div class="stat-item" style="border-left-color: var(--success)"><span>Net Profit</span><strong id="outPrf">0</strong></div>
        </div>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Order ID</th><th>SKU</th><th>Harga Satuan</th><th>Qty</th><th>Total Omzet</th><th>Admin</th><th>HPP</th><th>Profit</th>
                    </tr>
                </thead>
                <tbody id="bodyRes"></tbody>
            </table>
        </div>
        <button class="btn btn-success" onclick="simpanKeDB()">Simpan ke Dashboard</button>
    </div>
</div>

<script src="core-db.js"></script>
<script>
    let db, finalData;
    CoreDB.init().then(res => db = res);

    function formatIDR(n) { return "Rp " + Math.round(n).toLocaleString('id-ID'); }

    function cleanNum(v) { 
        if(!v) return 0; 
        if(typeof v === 'number') return v;
        let s = v.toString().replace(/Rp/g, '').replace(/\s/g, '');
        if (s.includes('.') && s.split('.').pop().length > 2) s = s.replace(/\./g, '');
        if (s.includes(',') && s.split(',').pop().length > 2) s = s.replace(/,/g, '');
        s = s.replace(',', '.');
        return parseFloat(s) || 0; 
    }

    async function prosesKalkulasi() {
        const file = document.getElementById('fileIn').files[0];
        const mp = document.getElementById('mPlace').value;
        const rate = parseFloat(document.getElementById('admRate').value) / 100;
        const pFee = parseFloat(document.getElementById('procFee').value);
        if(!file) return alert("Pilih file!");

        const master = {};
        db.transaction("master").objectStore("master").getAll().onsuccess = (e) => {
            e.target.result.forEach(m => master[m.sku] = m.price);
            const reader = new FileReader();
            reader.onload = (ev) => {
                const wb = XLSX.read(new Uint8Array(ev.target.result), {type: 'array'});
                const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                let sSal = 0, sHpp = 0, sAdm = 0, sPrf = 0, ords = new Set();
                const body = document.getElementById('bodyRes'); body.innerHTML = '';

                // LOGIKA PEMBAGIAN BIAYA PROSES (Sangat Penting untuk Lazada)
                const orderOccurrenceMap = {};
                rows.forEach(r => {
                    let idTemp = (mp === "Tokopedia") ? r['Order ID'] : (mp === "Shopee" ? r['No. Pesanan'] : r['orderNumber']);
                    if(idTemp) orderOccurrenceMap[idTemp] = (orderOccurrenceMap[idTemp] || 0) + 1;
                });

                rows.forEach(r => {
                    let oid, sku, qty, hSatuan;
                    if (mp === "Tokopedia") {
                        oid = (r['Order ID'] || "").toString().trim();
                        sku = (r['Seller SKU'] || "").toString().trim().toUpperCase();
                        qty = parseInt(r['Quantity'] || 0);
                        hSatuan = cleanNum(r['SKU Unit Original Price']);
                        if (oid.includes("Platform") || !oid) return; 
                    } else if (mp === "Shopee") {
                        oid = (r['No. Pesanan'] || "").toString().trim();
                        sku = (r['Nomor Referensi SKU'] || "").toString().trim().toUpperCase();
                        qty = parseInt(r['Jumlah'] || 0);
                        hSatuan = cleanNum(r['Harga Setelah Diskon']);
                    } else if (mp === "Lazada") {
                        oid = (r['orderNumber'] || "").toString().trim();
                        sku = (r['sellerSku'] || "").toString().trim().toUpperCase();
                        qty = 1; 
                        hSatuan = cleanNum(r['unitPrice']);
                    }

                    if(oid && sku && qty > 0) {
                        const tJual = hSatuan * qty;
                        const tHpp = (master[sku] || 0) * qty;
                        
                        // Biaya Proses dibagi dengan jumlah kemunculan Order ID dalam file
                        const biayaProsesTerbagi = pFee / (orderOccurrenceMap[oid] || 1);
                        const tAdm = (tJual * rate) + biayaProsesTerbagi;
                        
                        const profit = tJual - tHpp - tAdm;

                        sSal += tJual; sHpp += tHpp; sAdm += tAdm; sPrf += profit;
                        ords.add(oid);
                        body.innerHTML += `<tr><td>${oid}</td><td><b>${sku}</b></td><td>${formatIDR(hSatuan)}</td><td>${qty}</td><td>${formatIDR(tJual)}</td><td style="color:var(--danger)">${formatIDR(tAdm)}</td><td style="color:var(--warning)">${formatIDR(tHpp)}</td><td class="${profit >= 0 ? 'text-profit' : 'text-loss'}">${formatIDR(profit)}</td></tr>`;
                    }
                });
                document.getElementById('outOrd').innerText = ords.size;
                document.getElementById('outSal').innerText = formatIDR(sSal);
                document.getElementById('outCost').innerText = formatIDR(sHpp + sAdm);
                document.getElementById('outPrf').innerText = formatIDR(sPrf);
                document.getElementById('resArea').style.display = 'block';
                finalData = { sales: sSal, profit: sPrf, orders: ords.size, mplace: mp, store: document.getElementById('storeName').value, month: document.getElementById('reportMonth').value };
            };
            reader.readAsArrayBuffer(file);
        };
    }

    function simpanKeDB() {
        const tx = db.transaction("history", "readwrite");
        tx.objectStore("history").add(finalData);
        tx.oncomplete = () => { alert("Rekap V7 Berhasil Disimpan!"); window.location.href = "index.html"; };
    }
</script>
</body>
</html>