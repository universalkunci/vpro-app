<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>V-PRO MAX - Produk</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --slate-800: #1e293b; --primary: #4f46e5; }
        body { background: #f1f5f9; font-family: sans-serif; margin: 0; font-size: 13px; }
        .nav { background: var(--slate-800); padding: 1rem 2rem; display: flex; justify-content: space-between; color: white; align-items: center; }
        .nav a { color: #94a3b8; text-decoration: none; margin-left: 1rem; font-weight: bold; }
        .container { max-width: 1250px; margin: 20px auto; display: grid; grid-template-columns: 1fr 350px; gap: 20px; padding: 0 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:100; }
        .modal-content { background:white; width:800px; margin:30px auto; padding:20px; border-radius:10px; }
    </style>
</head>
<body>
    <nav class="nav">
        <strong>UNIVERSAL GROUP V-PRO MAX</strong>
        <div><a href="index.html">Dashboard</a><a href="produk.html" style="color:white">Produk</a><a href="pembelian.html">Pembelian</a><a href="penjualan.html">Penjualan</a></div>
    </nav>

    <div class="container">
        <div class="card">
            <div style="display:flex; gap:10px; margin-bottom:15px">
                <input type="text" id="search" placeholder="Cari SKU/Nama..." style="flex-grow:1; padding:8px" onkeyup="render()">
                <button onclick="document.getElementById('fEx').click()">Upload Excel</button>
                <input type="file" id="fEx" hidden onchange="uploadMasal(event)">
                <button style="background:#ef4444; color:white; border:none; padding:8px; cursor:pointer" onclick="hapusSemua()">Hapus Semua</button>
            </div>
            <table id="pTable">
                <thead><tr style="background:#f8fafc"><th>SKU</th><th>Nama Barang</th><th>HPP</th><th>Stok</th><th>Aksi</th></tr></thead>
                <tbody id="pBody"></tbody>
            </table>
        </div>

        <div class="card">
            <h3 id="formTitle">Tambah Produk</h3>
            <input type="text" id="sku" placeholder="SKU" style="width:100%; padding:10px; margin-bottom:10px">
            <input type="text" id="nama" placeholder="Nama Barang" style="width:100%; padding:10px; margin-bottom:10px">
            <input type="number" id="hpp" placeholder="Harga Modal (HPP)" style="width:100%; padding:10px; margin-bottom:10px">
            <button onclick="save()" style="width:100%; padding:12px; background:var(--primary); color:white; border:none; cursor:pointer">Simpan Ke Cloud</button>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <h3 id="mTitle">Kartu Stok</h3>
            <table style="font-size:12px">
                <thead><tr style="background:#1e293b; color:white"><th>Tanggal</th><th>Ket</th><th>Masuk</th><th>Keluar</th><th>Sisa</th></tr></thead>
                <tbody id="hBody"></tbody>
            </table>
            <button onclick="document.getElementById('modal').style.display='none'" style="margin-top:15px">Tutup</button>
        </div>
    </div>

    <script type="module">
    import { CloudDB } from './core-db.js';
    
    // Semua kode Anda harus berada di DALAM tag script ini
    // agar bisa mengakses CloudDB

        window.render = async function() {
            const query = document.getElementById('search').value.toUpperCase();
            const products = await CloudDB.getAll("products");
            const history = await CloudDB.getAll("stock_history");
            const tbody = document.getElementById('pBody');
            tbody.innerHTML = products.filter(p => p.id.includes(query) || p.nama.toUpperCase().includes(query)).map(p => {
                const stok = history.filter(h => h.sku === p.id).reduce((a, b) => a + (b.type === 'IN' ? b.qty : -b.qty), 0);
                return `<tr><td><b>${p.id}</b></td><td>${p.nama}</td><td>${p.hpp.toLocaleString()}</td><td><b>${stok}</b></td>
                <td><button onclick="showHist('${p.id}')">üìë</button> <button onclick="hapusSatu('${p.id}')">üóëÔ∏è</button></td></tr>`;
            }).join('');
        };

        window.showHist = async function(sku) {
            document.getElementById('mTitle').innerText = "Kartu Stok: " + sku;
            const history = await CloudDB.getAll("stock_history");
            const filtered = history.filter(h => h.sku === sku).sort((a,b) => new Date(a.date) - new Date(b.date));
            let s = 0;
            document.getElementById('hBody').innerHTML = filtered.map(h => {
                const i = h.type==='IN'?h.qty:0, o = h.type==='OUT'?h.qty:0; s+=(i-o);
                return `<tr><td>${h.date}</td><td>${h.note}</td><td style="color:green">${i||'-'}</td><td style="color:red">${o||'-'}</td><td><b>${s}</b></td></tr>`;
            }).reverse().join('');
            document.getElementById('modal').style.display='block';
        };

        window.uploadMasal = async function(e) {
            const reader = new FileReader();
            reader.onload = async (ev) => {
                const rows = XLSX.utils.sheet_to_json(XLSX.read(new Uint8Array(ev.target.result), {type:'array'}).Sheets[XLSX.read(new Uint8Array(ev.target.result), {type:'array'}).SheetNames[0]]);
                for(let r of rows) {
                    const sku = r.SKU.toString().toUpperCase().trim();
                    await CloudDB.set("products", sku, { nama: r.NAMA, hpp: r.HPP });
                    if(r.STOK > 0) await CloudDB.add("stock_history", { sku, qty: r.STOK, type: 'IN', date: new Date().toLocaleString(), note: 'Awal' });
                }
                alert("Selesai!"); location.reload();
            };
            reader.readAsArrayBuffer(e.target.files[0]);
        };

        window.hapusSatu = async function(id) { if(confirm("Hapus?")) { await CloudDB.delete("products", id); render(); } };
        window.hapusSemua = async function() { if(confirm("Hapus Permanen SEMUA Data?")) { const p = await CloudDB.getAll("products"); for(let i of p) await CloudDB.delete("products", i.id); location.reload(); } };

        render();
    </script>
</body>
</html>